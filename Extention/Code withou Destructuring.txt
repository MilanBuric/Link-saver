let myleads = []; 
const inputBtn = document.getElementById("input-btn");
const inputEl = document.getElementById("input-el");
const ulEl = document.getElementById("ul-el");
const deleteBtn = document.getElementById("delete-btn");
const deleteSelectedBtn = document.getElementById("delete-selected-btn");
const saveTabBtn = document.getElementById("save-tab-btn");

// Load saved leads from chrome.storage when the extension is opened
chrome.storage.sync.get(["leads"], function(result) {
    if (result.leads) {
        myleads = result.leads;
        renderLeads();
    }
});

// Add an event listener to the input button
inputBtn.addEventListener("click", function() {
    const inputValue = inputEl.value.trim();
    console.log("Input value:", inputValue);
    if (inputValue) {
    // Check if the URL exists in the myleads array
    // If it exists, alert the user and do not add it again
    const alreadyExists = myleads.some(lead =>
        (typeof lead === "object" && lead.url === inputValue) ||
        (typeof lead === "string" && lead === inputValue)
    );

    if (alreadyExists) {
        alert("This URL is already saved.");
        return;
    }

    fetchPageTitle(inputValue, function(title) {
        const newLead = {
            url: inputValue,
            title: title
        };

        myleads.push(newLead);

        chrome.storage.sync.set({ leads: myleads }, function() {
            renderLeads();
            console.log("Current leads:", myleads);
            alert("Input saved: " + inputValue);
            inputEl.value = "";
        });
    });
} else {
        console.log("Input field is empty.");
    }
});

// Add an event listener to the input field to handle the Enter key
inputEl.addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
        inputBtn.click(); // simulate button click on Enter key
        event.preventDefault(); // prevent form submission if inside a form
    }
});

// Add an event listener to the delete selected button
// This will remove all selected links from the list
deleteSelectedBtn.addEventListener("click", function () {
    const checkboxes = document.querySelectorAll(".lead-checkbox:checked");

    if (checkboxes.length === 0) {
        alert("NO links selected for deletion.");
        return;
    }

    const indicesToRemove = Array.from(checkboxes).map(cb => parseInt(cb.dataset.index));

    // Sorting backwards to avoid index shifting issues
    indicesToRemove.sort((a, b) => b - a).forEach(index => {
        myleads.splice(index, 1);
    });

    chrome.storage.sync.set({ leads: myleads }, function () {
        renderLeads();
        alert("Selected links have been deleted.");
    });
});

// Function to extract the hostname from a URL
function extractHostname(url) {
    try {
        const hostname = new URL(url).hostname;
        return hostname.replace("www.", ""); 
    } catch (e) {
        return url; // fallback if the URL is invalid
    }
}

// Function to render the leads in the unordered list
// This function clears the current list and repopulates it with the saved leads
// It also adds a checkbox for each lead to allow for selection
function renderLeads() {
    ulEl.innerHTML = "";
    // Populate the list with saved leads
    for (let i = 0; i < myleads.length; i++) {
        const li = document.createElement("li");
        
        // Create a checkbox and link for each lead
        // The checkbox allows the user to select leads for deletion
        const checkboxWrapper = document.createElement("div");
        checkboxWrapper.className = "checkbox-wrapper";

        // Create a checkbox input element
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.className = "lead-checkbox";
        checkbox.dataset.index = i;
        checkboxWrapper.appendChild(checkbox);

        // Create a link element for the lead
        const linkWrapper = document.createElement("div");
        linkWrapper.className = "link-wrapper";

        // Create an anchor element for the link
        const a = document.createElement("a");

        let url, title, originalUrl;

        if (typeof myleads[i] === "object" && myleads[i] !== null) {
            url = myleads[i].url;
            title = myleads[i].title || extractHostname(myleads[i].url);
            originalUrl = myleads[i].originalUrl || url;
        } else {
            url = myleads[i];
            title = extractHostname(myleads[i]);
            originalUrl = url;
        }

        a.href = url;
        a.target = "_blank";

        // Set the text content of the link to the hostname or title
        const favicon = document.createElement("img");
        favicon.src = `https://www.google.com/s2/favicons?domain=${originalUrl}`;
        favicon.style.width = "16px";
        favicon.style.height = "16px";
        favicon.style.marginRight = "8px";
        favicon.style.verticalAlign = "middle";

        const siteName = document.createTextNode(title);
        
        // Set the title attribute to show the full URL on hover
        a.appendChild(favicon);
        a.appendChild(siteName);
        
        linkWrapper.appendChild(a);
        li.appendChild(checkboxWrapper);
        li.appendChild(linkWrapper);
        ulEl.appendChild(li);
    }
}

// Event listener for the delete button
// This will clear all saved leads and update the UI
deleteBtn.addEventListener("click", function() {
    // delete all leads
    myleads = [];
    chrome.storage.sync.remove("leads", function() {
        console.log("All saved links have been deleted.");
        renderLeads(); // Clear the list in the UI
        alert("All saved links have been deleted.");
    });
});

// Function to shorten a URL using TinyURL API
// This function takes a long URL and a callback function as parameters
function shortenUrl(longUrl, callback) {
    fetch(`https://api.tinyurl.com/create`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer lizhlveH9IdfgKSre0GiiwoM7w0Af6MJzWk6ZSzOkXQFUUJRFip8uxeDgSpH" // TinyURL API key
        },
        body: JSON.stringify({
            url: longUrl,   
            domain: "tiny.one" // or "tinyurl.com"
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.data && data.data.tiny_url) {
            callback(data.data.tiny_url);
        } else {
            alert("Failed to shorten URL. Saving original.");
            callback(longUrl); // fallback
        }
    })
    .catch(() => {
        alert("Error shortening URL.");
        callback(longUrl); // fallback
    });
}

// Event listener for the save tab button
// This will save the current tab's URL to the leads list
saveTabBtn.addEventListener("click", function () {
    chrome.tabs.query({ active: true, currentWindow: true }, function (tabs) {
        const currentUrl = tabs[0].url;
        const pageTitle = tabs[0].title;

 shortenUrl(currentUrl, function(shortUrl) {
     // if the URL is already in the list, alert the user
        const alreadyExists = myleads.some(lead => typeof lead === "object" && lead.url === shortUrl);
        if (alreadyExists) {
            alert("This URL is already saved.");
            return;
        }

         myleads.push({
             url: shortUrl,
             title: pageTitle,
             originalUrl: currentUrl // add original URL for reference
        });

        // Save the new lead to chrome.storage
            chrome.storage.sync.set({ leads: myleads }, function () {
                renderLeads();
                alert("Shortened link saved: " + shortUrl);
            });
        });
    });
});

// Function to fetch the page title from a URL
// This function uses the Fetch API to get the HTML content of the page
function fetchPageTitle(url, callback) {
    fetch(url)
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, "text/html");
            const title = doc.querySelector("title");
            callback(title ? title.textContent : extractHostname(url));
        })
        .catch(() => {
            callback(extractHostname(url)); // fallback to hostname
        });
}

// Event listener for the export button
// This will export the saved links to a JSON file
document.getElementById("export-btn").addEventListener("click", function () {
    chrome.storage.sync.get(["leads"], function (result) {
    const dataStr = "data:text/json;charset=utf-8," + 
        encodeURIComponent(JSON.stringify(result.leads || []));
    
    const downloadAnchorNode = document.createElement('a');
    downloadAnchorNode.setAttribute("href", dataStr);
    downloadAnchorNode.setAttribute("download", "saved_links.json");
    document.body.appendChild(downloadAnchorNode);
    downloadAnchorNode.click();
    downloadAnchorNode.remove();
    });
});

// Event listener for the import button
// This will import links from a JSON file and merge them with existing links
document.getElementById("import-btn").addEventListener("click", function () {
    const fileInput = document.getElementById("import-file");
    const file = fileInput.files[0];

    if (!file) {
        alert("File not selected!");
        return;
    }

    const reader = new FileReader();
    reader.onload = function (event) {
        try {
            const importedLinks = JSON.parse(event.target.result);

            if (!Array.isArray(importedLinks)) {
                alert("Invalid file format.");
                return;
            }

            chrome.storage.sync.get(["leads"], function (result) {
                const existingLinks = result.leads || [];
                const mergedLinks = [...existingLinks, ...importedLinks];

                chrome.storage.sync.set({ leads: mergedLinks }, function () {
                    alert("Import successful!");
                    location.reload();
                });
            });
        } catch (e) {
            alert("file read error.");
        }
    };

    reader.readAsText(file);
});